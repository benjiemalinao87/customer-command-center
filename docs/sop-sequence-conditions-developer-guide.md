# Sequence Condition Steps - Developer Guide

**Version:** 1.0
**Last Updated:** February 2026
**Audience:** Developers, Interns, Technical Staff

---

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [State Machine](#state-machine)
3. [Data Flow](#data-flow)
4. [Routing Options](#routing-options)
5. [Database Schema](#database-schema)
6. [Code Paths](#code-paths)
7. [Execution Engine](#execution-engine)
8. [Filtering Systems Comparison](#filtering-systems-comparison)
9. [Implementation Patterns](#implementation-patterns)
10. [Debugging Guide](#debugging-guide)

---

## Architecture Overview

### System Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FRONTEND                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  TwoColumnSequenceBuilder.js                                         â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ConditionStepEditor.js (UI for branch configuration)           â”‚   â”‚
â”‚  â”‚      â””â”€â”€ ConditionGroup.js (individual condition rows)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SequenceService.js                                                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€ createSequence() / updateSequence()                            â”‚   â”‚
â”‚  â”‚      sends: { branches, otherwiseAction, branchId }                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ HTTP POST/PUT
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              BACKEND                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  backend/src/services/sequenceService.js                             â”‚   â”‚
â”‚  â”‚  â””â”€â”€ createSequence() / updateSequence()                            â”‚   â”‚
â”‚  â”‚      INSERT/UPDATE to flow_sequence_messages                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  backend/src/services/sequenceService.js                             â”‚   â”‚
â”‚  â”‚  â””â”€â”€ convertSequenceToWorkflow()                                    â”‚   â”‚
â”‚  â”‚      Converts sequence messages â†’ workflow nodes/edges              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ Trigger.dev task
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TRIGGER.DEV                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  trigger/unifiedWorkflows.js                                         â”‚   â”‚
â”‚  â”‚  â””â”€â”€ triggerWorkflowTask                                            â”‚   â”‚
â”‚  â”‚      â””â”€â”€ executeWorkflowStep()                                      â”‚   â”‚
â”‚  â”‚          â””â”€â”€ case 'condition': evaluateConditionForWorkflow()       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATABASE                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  flow_sequences              â”‚  flow_sequence_messages              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ id                      â”‚  â”œâ”€â”€ id                              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ name                    â”‚  â”œâ”€â”€ sequence_id (FK)                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ settings                â”‚  â”œâ”€â”€ step_type ('condition')         â”‚   â”‚
â”‚  â”‚  â””â”€â”€ auto_stop_rules         â”‚  â”œâ”€â”€ branches (JSONB)                â”‚   â”‚
â”‚  â”‚                              â”‚  â”œâ”€â”€ otherwise_action                â”‚   â”‚
â”‚  â”‚                              â”‚  â””â”€â”€ branch_id                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Machine

### Sequence Execution State Machine

```
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚     START       â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ ENROLLMENT      â”‚
                                 â”‚ CHECK           â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚                     â”‚
                    â–¼                     â–¼                     â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ RULES PASS    â”‚     â”‚ RULES FAIL    â”‚     â”‚ ALREADY       â”‚
           â”‚               â”‚     â”‚               â”‚     â”‚ ENROLLED      â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                     â”‚                     â”‚
                   â–¼                     â–¼                     â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ CREATE        â”‚     â”‚ REJECTED      â”‚     â”‚ DUPLICATE     â”‚
           â”‚ EXECUTION     â”‚     â”‚ (end)         â”‚     â”‚ (end)         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ EXECUTE       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ STEP          â”‚                                   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
                   â”‚                                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
         â”‚                   â”‚                                â”‚
         â–¼                   â–¼                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ REGULAR STEP    â”‚  â”‚ CONDITION STEP  â”‚                     â”‚
â”‚ (SMS/Email/etc) â”‚  â”‚                 â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
         â”‚                    â”‚                               â”‚
         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
         â”‚           â”‚                 â”‚                     â”‚
         â”‚           â–¼                 â–¼                     â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
         â”‚  â”‚ BRANCH       â”‚  â”‚ NO BRANCH    â”‚              â”‚
         â”‚  â”‚ MATCHED      â”‚  â”‚ MATCHED      â”‚              â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
         â”‚         â”‚                 â”‚                       â”‚
         â”‚         â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
         â”‚         â”‚        â”‚                 â”‚             â”‚
         â”‚         â”‚        â–¼                 â–¼             â”‚
         â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
         â”‚         â”‚  â”‚ OTHERWISE â”‚    â”‚ OTHERWISE â”‚       â”‚
         â”‚         â”‚  â”‚ = STOP    â”‚    â”‚ = CONTINUEâ”‚       â”‚
         â”‚         â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚         â”‚        â”‚                â”‚              â”‚
         â”‚         â”‚        â–¼                â”‚              â”‚
         â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚              â”‚
         â”‚         â”‚  â”‚ CANCELLED â”‚          â”‚              â”‚
         â”‚         â”‚  â”‚ (end)     â”‚          â”‚              â”‚
         â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚              â”‚
         â”‚         â”‚                         â”‚              â”‚
         â”‚         â–¼                         â–¼              â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
         â”‚  â”‚ SET matchedBranchId IN CONTEXT    â”‚          â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚                   â”‚                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                            â”‚
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CHECK AUTO-STOP â”‚
                    â”‚ RULES           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                           â”‚
               â–¼                           â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ RULES PASS      â”‚         â”‚ RULES FAIL      â”‚
      â”‚ (continue)      â”‚         â”‚ (stop)          â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                           â”‚
               â–¼                           â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ FIND NEXT       â”‚         â”‚ CANCELLED       â”‚
      â”‚ STEP            â”‚         â”‚ (end)           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                 â”‚
      â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HAS NEXT  â”‚    â”‚ NO NEXT   â”‚
â”‚ STEP      â”‚    â”‚ STEP      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚                â”‚
      â”‚                â–¼
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚         â”‚ COMPLETED â”‚
      â”‚         â”‚ (end)     â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º (back to EXECUTE STEP)
```

### Message Execution with branchId

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ABOUT TO EXECUTE        â”‚
                    â”‚ MESSAGE STEP            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CHECK: Does message     â”‚
                    â”‚ have branchId?          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                   â”‚
              â–¼                                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ YES: branchId   â”‚                 â”‚ NO: branchId    â”‚
    â”‚ exists          â”‚                 â”‚ is null         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                   â”‚
             â–¼                                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
    â”‚ CHECK: Does branchId    â”‚                 â”‚
    â”‚ match matchedBranchId   â”‚                 â”‚
    â”‚ from context?           â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                â”‚                               â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
      â”‚                   â”‚                    â”‚
      â–¼                   â–¼                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚ MATCH     â”‚       â”‚ NO MATCH  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
      â”‚                   â”‚                    â”‚
      â”‚                   â–¼                    â”‚
      â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
      â”‚           â”‚ SKIP MESSAGE  â”‚           â”‚
      â”‚           â”‚ (don't send)  â”‚           â”‚
      â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
      â”‚                                        â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ EXECUTE MESSAGE â”‚
                  â”‚ (send SMS/Email)â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow

### Sequence Creation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER ACTION: Click "Add Condition" in Sequence Builder                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TwoColumnSequenceBuilder.js                                              â”‚
â”‚                                                                          â”‚
â”‚ handleAddCondition() creates:                                            â”‚
â”‚ {                                                                        â”‚
â”‚   id: generateUUID(),                                                    â”‚
â”‚   stepType: 'condition',                                                 â”‚
â”‚   stepName: 'Condition 1',                                               â”‚
â”‚   branches: [{                                                           â”‚
â”‚     id: generateUUID(),                                                  â”‚
â”‚     label: 'Branch 1',                                                   â”‚
â”‚     conditions: [{ field: '', operator: '', value: '' }],                â”‚
â”‚     logicOperator: 'AND'                                                 â”‚
â”‚   }],                                                                    â”‚
â”‚   otherwiseAction: 'stop'                                                â”‚
â”‚ }                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER ACTION: Configure conditions and click "Save"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SequenceService.js - createSequence() / updateSequence()                 â”‚
â”‚                                                                          â”‚
â”‚ Formats data for backend:                                                â”‚
â”‚ {                                                                        â”‚
â”‚   stepType: message.stepType || 'message',                               â”‚
â”‚   branches: message.branches || null,           â—„â”€â”€ NEW FIELD            â”‚
â”‚   otherwiseAction: message.otherwiseAction || null,  â—„â”€â”€ NEW FIELD       â”‚
â”‚   ...other fields                                                        â”‚
â”‚ }                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼ POST /api/workspaces/:id/sequences
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ backend/src/services/sequenceService.js                                  â”‚
â”‚                                                                          â”‚
â”‚ INSERT into flow_sequence_messages:                                      â”‚
â”‚ {                                                                        â”‚
â”‚   sequence_id: ...,                                                      â”‚
â”‚   step_type: 'condition',                                                â”‚
â”‚   branches: { ... },              â—„â”€â”€ JSONB column                       â”‚
â”‚   otherwise_action: 'stop',       â—„â”€â”€ TEXT column                        â”‚
â”‚   ...                                                                    â”‚
â”‚ }                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE: flow_sequence_messages                                         â”‚
â”‚                                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ id     â”‚ step_type  â”‚ branches                  â”‚ otherwise_action â”‚  â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ â”‚ uuid-1 â”‚ condition  â”‚ [{id, label, conditions}] â”‚ stop             â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sequence Execution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER/SYSTEM ACTION: Enroll contact in sequence                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ trigger/unifiedWorkflows.js - subscribeCampaignDirectly()                â”‚
â”‚                                                                          â”‚
â”‚ 1. Fetch sequence with messages from DB                                  â”‚
â”‚ 2. convertSequenceToWorkflow(sequence, settings)                         â”‚
â”‚    - Creates workflow nodes for each step                                â”‚
â”‚    - Creates edges between nodes                                         â”‚
â”‚    - For condition steps: creates 'condition' type node                  â”‚
â”‚ 3. triggerWorkflowTask with workflow definition                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ trigger/unifiedWorkflows.js - triggerWorkflowTask                        â”‚
â”‚                                                                          â”‚
â”‚ Main execution loop:                                                     â”‚
â”‚ while (currentNode) {                                                    â”‚
â”‚   result = executeWorkflowStep(currentNode, context)                     â”‚
â”‚                                                                          â”‚
â”‚   if (currentNode.type === 'condition') {                                â”‚
â”‚     // Store matched branch in context                                   â”‚
â”‚     context.matchedBranchId = result.matchedBranchId                     â”‚
â”‚                                                                          â”‚
â”‚     if (result.matchedBranchId === 'otherwise' &&                        â”‚
â”‚         result.shouldStop) {                                             â”‚
â”‚       break; // Stop execution                                           â”‚
â”‚     }                                                                    â”‚
â”‚   }                                                                      â”‚
â”‚                                                                          â”‚
â”‚   currentNode = findNextNode(result)                                     â”‚
â”‚ }                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ trigger/unifiedWorkflows.js - executeWorkflowStep()                      â”‚
â”‚                                                                          â”‚
â”‚ case 'condition':                                                        â”‚
â”‚   // Fetch fresh contact data                                            â”‚
â”‚   const contact = await fetchContact(contactId)                          â”‚
â”‚                                                                          â”‚
â”‚   // Evaluate each branch in order                                       â”‚
â”‚   for (const branch of data.branches) {                                  â”‚
â”‚     const conditions = branch.conditions                                 â”‚
â”‚     const results = conditions.map(c =>                                  â”‚
â”‚       evaluateConditionForWorkflow(c, contact)                           â”‚
â”‚     )                                                                    â”‚
â”‚                                                                          â”‚
â”‚     const passed = branch.logicOperator === 'AND'                        â”‚
â”‚       ? results.every(r => r)                                            â”‚
â”‚       : results.some(r => r)                                             â”‚
â”‚                                                                          â”‚
â”‚     if (passed) {                                                        â”‚
â”‚       return { matchedBranchId: branch.id }  // First match wins         â”‚
â”‚     }                                                                    â”‚
â”‚   }                                                                      â”‚
â”‚                                                                          â”‚
â”‚   // No branch matched                                                   â”‚
â”‚   return {                                                               â”‚
â”‚     matchedBranchId: 'otherwise',                                        â”‚
â”‚     shouldStop: data.otherwiseAction === 'stop'                          â”‚
â”‚   }                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Routing Options

### Option A: Linear with branchId (Simple)

Messages have `branchId` - only execute if that branch was matched.

```
SEQUENCE STRUCTURE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: SMS (no branchId) - "Welcome!"                 â”‚
â”‚     â”‚                                                  â”‚
â”‚     â–¼                                                  â”‚
â”‚ Step 2: CONDITION                                      â”‚
â”‚     â”‚   Branch A: product = "Windows"                  â”‚
â”‚     â”‚   Branch B: product = "Roofing"                  â”‚
â”‚     â”‚                                                  â”‚
â”‚     â–¼                                                  â”‚
â”‚ Step 3: SMS (branchId: A) - "Windows info"             â”‚
â”‚     â”‚                                                  â”‚
â”‚     â–¼                                                  â”‚
â”‚ Step 4: SMS (branchId: B) - "Roofing info"             â”‚
â”‚     â”‚                                                  â”‚
â”‚     â–¼                                                  â”‚
â”‚ Step 5: SMS (no branchId) - "Call us!"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EXECUTION FOR WINDOWS LEAD:
Step 1 â”€â”€â–º Step 2 â”€â”€â–º Step 3 â”€â”€â–º [Skip 4] â”€â”€â–º Step 5
                        â–²
                   (branchId: A matches)

EXECUTION FOR ROOFING LEAD:
Step 1 â”€â”€â–º Step 2 â”€â”€â–º [Skip 3] â”€â”€â–º Step 4 â”€â”€â–º Step 5
                                      â–²
                                (branchId: B matches)
```

**Pros:** Simple, linear timeline
**Cons:** Can't jump around, all branch messages in sequence

### Option B: GOTO Jump (Flexible)

Branches explicitly specify which step to jump to.

```
SEQUENCE STRUCTURE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: SMS - "Welcome!"                               â”‚
â”‚     â”‚                                                  â”‚
â”‚     â–¼                                                  â”‚
â”‚ Step 2: CONDITION                                      â”‚
â”‚     â”‚   Branch A: product = "Windows" â”€â”€â–º GOTO Step 3  â”‚
â”‚     â”‚   Branch B: product = "Roofing" â”€â”€â–º GOTO Step 5  â”‚
â”‚     â”‚                                                  â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚     â–¼             â”‚                                   â”‚
â”‚ Step 3: SMS       â”‚   "Windows info"                   â”‚
â”‚     â”‚             â”‚                                   â”‚
â”‚     â–¼             â”‚                                   â”‚
â”‚ Step 4: SMS       â”‚   "Windows follow-up"              â”‚
â”‚     â”‚             â”‚   â”€â”€â–º GOTO Step 7                  â”‚
â”‚     â”‚             â”‚                                   â”‚
â”‚     â”‚             â–¼                                   â”‚
â”‚     â”‚        Step 5: SMS   "Roofing info"              â”‚
â”‚     â”‚             â”‚                                   â”‚
â”‚     â”‚             â–¼                                   â”‚
â”‚     â”‚        Step 6: SMS   "Roofing follow-up"         â”‚
â”‚     â”‚             â”‚                                   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                             â”‚
â”‚                         â–¼                             â”‚
â”‚ Step 7: SMS - "Call us!"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EXECUTION FOR WINDOWS LEAD:
Step 1 â”€â”€â–º Step 2 â”€â”€â–º Step 3 â”€â”€â–º Step 4 â”€â”€â–º Step 7
                 â”‚
                 â””â”€â”€â–º (GOTO Step 3)

EXECUTION FOR ROOFING LEAD:
Step 1 â”€â”€â–º Step 2 â”€â”€â–º Step 5 â”€â”€â–º Step 6 â”€â”€â–º Step 7
                 â”‚
                 â””â”€â”€â–º (GOTO Step 5)
```

**Pros:** Full control, multi-step branches
**Cons:** Complex, potential for loops/dead ends

### Option C: Hybrid (Both)

Supports GOTO for explicit jumps AND branchId for filtering.

```
PRIORITY ORDER:
1. If branch has gotoStepId â†’ Jump to that step
2. If no gotoStepId â†’ Continue linearly
3. Before each message â†’ Check branchId filter
4. Messages without branchId â†’ Execute for all
```

---

## Database Schema

### Table: flow_sequence_messages

```sql
CREATE TABLE flow_sequence_messages (
    -- Existing columns
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sequence_id UUID NOT NULL REFERENCES flow_sequences(id),
    step_type TEXT NOT NULL DEFAULT 'message',
    text TEXT,
    message_type TEXT NOT NULL DEFAULT 'sms',
    time_value INTEGER NOT NULL,
    time_unit TEXT NOT NULL,
    order_index INTEGER NOT NULL,
    -- ... other existing columns ...

    -- NEW: Condition step columns
    branches JSONB,              -- Array of branch objects
    otherwise_action TEXT,       -- 'stop' or 'continue'
    branch_id UUID,              -- Links message to a branch
    step_name TEXT               -- Custom display name
);
```

### branches JSONB Structure

```json
{
  "branches": [
    {
      "id": "uuid-branch-1",
      "label": "Hot Leads",
      "conditions": [
        {
          "id": "uuid-cond-1",
          "field": "lead_status",
          "operator": "is",
          "value": "Hot",
          "caseSensitive": false
        }
      ],
      "logicOperator": "AND",
      "gotoStepId": null
    },
    {
      "id": "uuid-branch-2",
      "label": "Warm Leads",
      "conditions": [
        {
          "id": "uuid-cond-2",
          "field": "lead_status",
          "operator": "is",
          "value": "Warm",
          "caseSensitive": false
        }
      ],
      "logicOperator": "AND",
      "gotoStepId": null
    }
  ]
}
```

---

## Code Paths

### Key Files

| File | Purpose | Key Functions |
|------|---------|---------------|
| `frontend/src/components/flow-builder/sequences/enhanced/ConditionStepEditor.js` | UI for branch configuration | Component render |
| `frontend/src/components/flow-builder/sequences/SequenceService.js` | API calls | createSequence(), updateSequence() |
| `backend/src/services/sequenceService.js` | CRUD operations | createSequence(), updateSequence(), convertSequenceToWorkflow() |
| `trigger/unifiedWorkflows.js` | Execution engine | triggerWorkflowTask, executeWorkflowStep(), evaluateConditionForWorkflow() |

### Backend: sequenceService.js

**INSERT (createSequence) - Lines 72-106:**
```javascript
const stepsWithSequenceId = sequenceData.messages.map((step, index) => ({
  sequence_id: sequence.id,
  step_type: step.stepType || 'message',
  // ... existing fields ...

  // NEW: Condition step fields
  branches: step.branches || null,
  otherwise_action: step.otherwiseAction || null,
  branch_id: step.branchId || null,
  step_name: step.stepName || null
}));
```

**UPDATE - Lines 220-274:**
Same fields added to both `messagesToUpdate` and `newMessages` arrays.

**convertSequenceToWorkflow - Lines 1184-1400:**
```javascript
// Add handling for condition steps
if (stepType === 'condition' && step.branches) {
  nodes.push({
    id: stepNodeId,
    type: 'condition',
    data: {
      label: step.step_name || 'Condition',
      branches: step.branches,
      otherwiseAction: step.otherwise_action || 'stop'
    }
  });
}
```

### Trigger.dev: unifiedWorkflows.js

**Condition execution - Lines 5720-5985:**
```javascript
case 'condition':
  const branches = data?.branches;

  if (branches && Array.isArray(branches)) {
    for (const branch of branches) {
      // Evaluate conditions
      const passed = evaluateAllConditions(branch, contact);
      if (passed) {
        return { matchedBranchId: branch.id };
      }
    }
  }

  return {
    matchedBranchId: 'otherwise',
    shouldStop: data?.otherwiseAction === 'stop'
  };
```

**Condition evaluation - Lines 11699-11931:**
```javascript
function evaluateConditionForWorkflow(condition, contact) {
  const fieldValue = getFieldValue(contact, condition.field);

  switch (condition.operator) {
    case 'is':
      return fieldValue === condition.value;
    case 'is_not':
      return fieldValue !== condition.value;
    case 'contains':
      return fieldValue?.includes(condition.value);
    // ... more operators
  }
}
```

---

## Filtering Systems Comparison

### Two Systems - Different Purposes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FILTERING SYSTEMS COMPARISON                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   SETTINGS TAB            â”‚    â”‚   CONDITION STEPS          â”‚        â”‚
â”‚  â”‚   (Enrollment Rules)      â”‚    â”‚   (Builder)                â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚                           â”‚    â”‚                           â”‚        â”‚
â”‚  â”‚  WHEN: Before EACH step   â”‚    â”‚  WHEN: At condition step  â”‚        â”‚
â”‚  â”‚                           â”‚    â”‚                           â”‚        â”‚
â”‚  â”‚  PURPOSE: Gate/Filter     â”‚    â”‚  PURPOSE: Route/Branch    â”‚        â”‚
â”‚  â”‚  (yes/no, proceed/stop)   â”‚    â”‚  (path A, B, C, or stop)  â”‚        â”‚
â”‚  â”‚                           â”‚    â”‚                           â”‚        â”‚
â”‚  â”‚  OUTCOME:                 â”‚    â”‚  OUTCOME:                 â”‚        â”‚
â”‚  â”‚  - Continue sequence      â”‚    â”‚  - Take Branch A          â”‚        â”‚
â”‚  â”‚  - Stop sequence          â”‚    â”‚  - Take Branch B          â”‚        â”‚
â”‚  â”‚                           â”‚    â”‚  - Take Branch C          â”‚        â”‚
â”‚  â”‚                           â”‚    â”‚  - Otherwise: stop/continueâ”‚        â”‚
â”‚  â”‚                           â”‚    â”‚                           â”‚        â”‚
â”‚  â”‚  USE FOR:                 â”‚    â”‚  USE FOR:                 â”‚        â”‚
â”‚  â”‚  - Block unqualified      â”‚    â”‚  - Different messages     â”‚        â”‚
â”‚  â”‚  - Stop on status change  â”‚    â”‚  - A/B testing            â”‚        â”‚
â”‚  â”‚  - Stop on response       â”‚    â”‚  - Product-specific flow  â”‚        â”‚
â”‚  â”‚                           â”‚    â”‚                           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                         â”‚
â”‚  THEY COMPLEMENT EACH OTHER - NOT CONTRADICTING!                        â”‚
â”‚                                                                         â”‚
â”‚  Settings = "Should contact CONTINUE in sequence?"                      â”‚
â”‚  Conditions = "WHICH PATH should contact take?"                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Code Comparison

**Settings Tab (Auto-Stop Rules) - Checked before EACH step:**
```javascript
// In triggerWorkflowTask main loop
async function shouldContinueExecution(contact, settings) {
  // Check auto_stop_rules
  if (settings.stopOnResponse && contact.has_responded) {
    return false; // Stop
  }
  if (settings.stopOnStatusChange?.enabled) {
    const allowed = settings.stopOnStatusChange.statusValues;
    if (!allowed.includes(contact.lead_status)) {
      return false; // Stop
    }
  }
  return true; // Continue
}
```

**Condition Steps - Checked at specific step:**
```javascript
// In executeWorkflowStep, case 'condition'
function evaluateConditionStep(node, contact) {
  for (const branch of node.data.branches) {
    if (evaluateAllConditions(branch, contact)) {
      return { branchId: branch.id }; // Route to branch
    }
  }
  return { branchId: 'otherwise' }; // No match
}
```

---

## Implementation Patterns

### Adding a New Condition Operator

1. **Frontend** - Add to operator list in `ConditionGroup.js`:
```javascript
const operators = [
  { value: 'is', label: 'is' },
  { value: 'is_not', label: 'is not' },
  { value: 'my_new_operator', label: 'my new operator' }, // Add here
];
```

2. **Backend** - Add case in `evaluateConditionForWorkflow()`:
```javascript
case 'my_new_operator':
  return customLogic(fieldValue, condition.value);
```

### Adding a New Field Type

1. **Frontend** - Add to `UnifiedFieldPicker.js`
2. **Backend** - Handle in `getFieldValue()` function

---

## Debugging Guide

### Common Issues

| Issue | Likely Cause | Debug Steps |
|-------|--------------|-------------|
| Condition not evaluated | `branches` not saved to DB | Check DB for null branches |
| Wrong branch matched | Condition order | Branches evaluated in order - first match wins |
| All contacts stopping | `otherwiseAction: 'stop'` | Check if conditions are too strict |
| branchId not filtering | Field not set on messages | Check message has `branch_id` in DB |

### Debug Logging

Add to `trigger/unifiedWorkflows.js`:
```javascript
case 'condition':
  logger.log("ğŸ”€ Evaluating condition step", {
    nodeId: node.id,
    branchCount: data?.branches?.length,
    contactId,
    contactData: {
      lead_status: contact.lead_status,
      product_interest: contact.product_interest
    }
  });

  // After evaluation
  logger.log("ğŸ”€ Condition result", {
    matchedBranchId: result.matchedBranchId,
    matchedBranchLabel: result.matchedBranchLabel
  });
```

### Database Queries

**Check condition step data:**
```sql
SELECT id, step_type, step_name, branches, otherwise_action
FROM flow_sequence_messages
WHERE step_type = 'condition'
AND sequence_id = 'your-sequence-id';
```

**Check message branch assignments:**
```sql
SELECT id, step_type, message_type, branch_id, order_index
FROM flow_sequence_messages
WHERE sequence_id = 'your-sequence-id'
ORDER BY order_index;
```

**Check execution logs:**
```sql
SELECT * FROM flow_sequence_executions
WHERE sequence_id = 'your-sequence-id'
ORDER BY created_at DESC
LIMIT 10;
```

---

## Quick Reference

### Data Structures

```javascript
// Condition Step (in messages array)
{
  id: 'uuid',
  stepType: 'condition',
  stepName: 'Product Check',
  branches: [
    {
      id: 'uuid',
      label: 'Branch Name',
      conditions: [{ field, operator, value, caseSensitive }],
      logicOperator: 'AND' | 'OR',
      gotoStepId: null | 'uuid'  // Optional
    }
  ],
  otherwiseAction: 'stop' | 'continue'
}

// Regular Message with branchId
{
  id: 'uuid',
  stepType: 'message',
  messageType: 'sms',
  text: 'Hello!',
  branchId: 'uuid-of-branch'  // Optional - filters execution
}

// Execution Context
{
  matchedBranchId: 'uuid' | 'otherwise',
  // ... other context
}
```

### Supported Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `is` | Exact match | `lead_status is "Hot"` |
| `is_not` | Not equal | `lead_status is_not "Cold"` |
| `contains` | Substring | `email contains "@gmail"` |
| `not_contains` | No substring | `email not_contains "spam"` |
| `starts_with` | Prefix | `phone starts_with "+1"` |
| `ends_with` | Suffix | `email ends_with ".com"` |
| `is_empty` | Null/empty | `notes is_empty` |
| `is_not_empty` | Has value | `phone is_not_empty` |
| `greater_than` | Numeric | `lead_score greater_than 80` |
| `less_than` | Numeric | `lead_score less_than 20` |
